# Расширенный функционал диспетчера для системы KHTRM

## Обзор

Данный документ описывает расширенный функционал для роли "Нарядчик" в системе KHTRM, который включает все поля из оригинальной таблицы MS Access для управления зарядкой автобусов.

## Структура данных

### Расширенная модель Assignment

Новая модель Assignment включает все поля из таблицы MS Access:

#### Основная информация
- **assignment_date** (Дата зарядки) - Дата наряда
- **month** (Мт) - Месяц
- **brigade** (Бр) - Бригада
- **shift** (Смена) - Смена работы
- **application_number** (Заявка) - Номер заявки
- **address** (Адрес) - Адрес

#### Маршрут и тип
- **route_number** (Номер маршрута) - Основной идентификатор маршрута
- **route_type** (Тип) - Тип транспорта
- **internal_number** (№ в) - Внутренний номер

#### Топливо
- **fuel_route** (Марш топливо) - Маршрут топлива
- **fuel_address** (Адрес заправки) - Адрес заправочной станции
- **driver_waybill** (ПБ вод) - Путевой билет водителя

#### Рабочие часы (5 периодов)
- **hour1** (Час1) - Первый час работы
- **hour2** (Час2) - Второй час работы
- **hour3** (Час3) - Третий час работы
- **hour4** (Час4) - Четвертый час работы
- **hour5** (Час5) - Пятый час работы

#### Времена отправления и прибытия
- **waybill_number** (П.Б.) - Номер путевого билета
- **departure_vzd** (Взд) - Время выезда
- **departure_zgd** (Згд) - Время заезда
- **end_kb** (К.Б.) - Конец работы

#### Перерывы
- **break_1** (Пер.1) - Первый перерыв
- **break_2** (Пер.2) - Второй перерыв

#### Прибыльность
- **profit_start** (П.выг) - Начало прибыльности
- **profit_end** (К.выг) - Конец прибыльности

#### Информация о транспорте
- **vehicle_number** (Н.авт) - Номер автобуса
- **vehicle_model** (М.авт) - Модель автобуса
- **vehicle_bedt** (М.Бедт) - Код М.Бедт
- **coal_info** (Вугл) - Информация об угле
- **vehicle_type_pc** (Тип PC) - Тип подвижного состава
- **state_number_pc** (Держ.№ PC) - Государственный номер

#### Персонал
- **driver_tab_number** (Табельный номер водителя)
- **driver_name** (ФИО водителя)
- **conductor_tab_number** (Табельный номер кондуктора)
- **conductor_name** (ФИО кондуктора)

#### Стандартное расписание
- **departure_time** (Время выхода)
- **arrival_time** (Время захода)
- **route_endpoint** (Конечная остановка)

## API Endpoints

### 1. Простой вид нарядов
```
GET /api/dispatcher/simple-assignments
```
Возвращает базовые поля для простого отображения.

### 2. Расширенный вид нарядов
```
GET /api/dispatcher/extended-assignments
```
Возвращает расширенный набор полей с основной информацией.

### 3. Полный вид нарядов (MS Access)
```
GET /api/dispatcher/full-assignments
```
Возвращает все поля в точности как в MS Access таблице.

### 4. Статистика диспетчера
```
GET /api/dispatcher/statistics
```
Возвращает статистику по нарядам:
- Общее количество нарядов
- Активные наряды
- Завершенные наряды
- Количество маршрутов, водителей, транспорта
- Статистика по сменам

### 5. Доступные даты
```
GET /api/dispatcher/available-dates
```
Возвращает список дат, для которых есть данные о нарядах.

## Параметры запросов

Все endpoints поддерживают следующие параметры:

- **assignment_date** (YYYY-MM-DD) - Дата нарядов
- **limit** (число) - Ограничение количества записей

## Типы представлений

### 1. Simple View (Простой вид)
Основные поля для быстрого обзора:
- Маршрут, Смена, Водитель, Авто, Время выхода/захода, Статус

### 2. Extended View (Расширенный вид)
Дополнительные поля для детального анализа:
- Бригада, Табельные номера, Кондуктор, Гос.номер, Путевой лист, Заправка, Конечная

### 3. Full MS Access View (Полный вид)
Все поля как в оригинальной таблице MS Access:
- Все 41 поле из таблицы зарядки автобусов

## Извлечение данных из MySQL

### Скрипт извлечения данных
Используйте скрипт `scripts/extract_mysql_data.py` для извлечения данных из удаленной MySQL базы:

```bash
cd scripts
python extract_mysql_data.py --limit 1000
```

### Параметры скрипта:
- **--limit** - Ограничение количества записей
- **--start-date** - Начальная дата (YYYY-MM-DD)
- **--end-date** - Конечная дата (YYYY-MM-DD)

### Конфигурация базы данных
Настройте параметры подключения в файле скрипта:

```python
DB_CONFIG = {
    'host': 'localhost',  # или IP удаленного сервера
    'port': 3306,
    'user': 'khtrm_remote',
    'password': 'KhTRM_2025!',
    'database': 'saltdepoavt_',
    'charset': 'utf8mb4'
}
```

## Frontend интеграция

### TypeScript типы
Новые TypeScript интерфейсы в `frontend/src/types/dispatcher.ts`:

- **Assignment** - Основной интерфейс для нарядов
- **MSAccessAssignment** - Интерфейс для полного вида MS Access
- **AssignmentsResponse** - Ответ API для нарядов
- **StatisticsResponse** - Ответ API для статистики

### Предустановленные колонки
Доступны предустановленные наборы колонок:

- **SIMPLE_COLUMNS** - Для простого вида
- **EXTENDED_COLUMNS** - Для расширенного вида
- **FULL_MS_ACCESS_COLUMNS** - Для полного вида MS Access

## Тестовые данные

### Enhanced Mock Data
Используйте файл `backend/mock_data/enhanced_dispatcher_data.json` для тестирования всех полей.

### Структура тестовых данных:
- 5 примеров нарядов со всеми полями
- Справочники маршрутов, сотрудников, транспорта
- Статистика по нарядам

## Использование

### 1. Запуск backend
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Запуск frontend
```bash
cd frontend
npm run dev
```

### 3. Проверка API
Откройте в браузере:
- http://localhost:8000/docs - Swagger документация
- http://localhost:8000/api/dispatcher/simple-assignments - Простые наряды
- http://localhost:8000/api/dispatcher/full-assignments - Полные наряды

## Миграция данных

### Шаги для подключения к реальной базе данных:

1. **Проверьте подключение к MySQL**
   ```bash
   cd scripts
   python extract_mysql_data.py --limit 10
   ```

2. **Обновите схему базы данных**
   ```bash
   cd backend
   python -c "from app.database_init import create_tables; create_tables()"
   ```

3. **Импортируйте данные**
   Используйте извлеченные данные для наполнения локальной базы

4. **Настройте подключение**
   Обновите `backend/app/config.py` для подключения к MySQL

## Роль "Нарядчик"

### Основные функции:
1. **Просмотр нарядов** - В трех режимах (простой, расширенный, полный)
2. **Фильтрация** - По дате, маршруту, смене, статусу
3. **Статистика** - Общая статистика по нарядам
4. **Экспорт** - Экспорт данных в различных форматах

### Права доступа:
- Чтение всех данных о нарядах
- Просмотр статистики
- Фильтрация и поиск
- Экспорт отчетов

## Поддержка

При возникновении проблем:

1. Проверьте логи в `mysql_extraction.log`
2. Убедитесь в доступности MySQL сервера
3. Проверьте правильность настроек подключения
4. Используйте тестовые данные для отладки

## Дальнейшее развитие

### Планируемые улучшения:
1. Редактирование нарядов
2. Создание новых нарядов
3. Печать путевых листов
4. Интеграция с системой GPS
5. Мобильное приложение для водителей 